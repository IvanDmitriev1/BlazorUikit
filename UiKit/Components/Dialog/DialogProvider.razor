@namespace UiKit.Components
@inherits UiKitRenderComponentBase

@inject IDialogService DialogService

@foreach (var (key, dialogReference) in _dialogByGuid)
{
    <DialogInstance @key="key" DialogReference="dialogReference"/>
}

@code
{
    readonly Dictionary<Guid, IDialogReferenceBase> _dialogByGuid = new(1);

    protected override void AddComponentCssClasses(ref CssBuilder cssBuilder) { }

    protected override void OnInitialized()
    {
        DialogService.AddDialogProvider(this);
    }

    public async Task ShowAsync(IDialogReferenceBase dialogReference)
    {
        _dialogByGuid.Add(dialogReference.Id, dialogReference);
        await InvokeAsync(StateHasChangedWithRendering);
    }

    private ValueTask OnLocationChanging(LocationChangingContext arg)
    {
        if (_dialogByGuid.Count > 0)
            return ValueTask.CompletedTask;

        foreach (var (_, dialogReferenceBase) in _dialogByGuid)
        {
            dialogReferenceBase.Cancel();
        }

        _dialogByGuid.Clear();
        StateHasChanged();

        return ValueTask.CompletedTask;
    }

    public void RemoveDialog(Guid id)
    {
        if (!_dialogByGuid.ContainsKey(id))
            return;

        _dialogByGuid.Remove(id);
        StateHasChangedWithRendering();
    }
}
